# 관리자 운영 기준표 (Admin Ops Taxonomy)

> 목적: 관리자 화면에서 “무엇이 주문/신청서/대여인지”, “어떤 것을 매출로 집계하는지”를
> 코드보다 먼저 고정해 누락/오해/정산 오류를 막는다.

---

## 1) 관리자 화면에서 사용하는 3가지 축(반드시 고정)

### A. 거래 종류(kind)

- ORDER: 일반 주문(스트링/라켓/클래스/패키지 등)
- STRINGING_APPLICATION: 교체 서비스 신청서(단독 신청 또는 주문/대여 연결)
- RENTAL: 라켓 대여 주문

### B. 카테고리(category)

- 스트링
- 라켓
- 교체서비스
- 패키지
- 클래스

### C. 연결 관계(link)

- SINGLE: 단독(연결 없음)
- LINKED_TO_ORDER: 주문에 연결됨 (stringing_application → orderId)
- LINKED_TO_RENTAL: 대여에 연결됨 (rental → stringingApplicationId 등)

---

## 2) 현재 구현된 7개 플로우 → DB/연결키 매핑

> “관리자 화면에서 한 줄(row)로 무엇을 보여줄지” 정의할 때 반드시 참고.

### Flow 1) 스트링 단품 구매

- 생성 문서: orders
- 관리자 목록 노출: /admin/orders
- 연결: 없음 (SINGLE)

### Flow 2) 스트링 단품 구매 + 교체서비스 신청 (연결된 통합)

- 생성 문서: orders + stringing_applications
- 관리자 목록 노출: /admin/orders (통합 그룹으로 묶임)
- 연결키:
  - stringing_applications.orderId → orders.\_id

### Flow 3) 교체서비스 단일 신청

- 생성 문서: stringing_applications
- 관리자 목록 노출: /admin/orders (서비스 타입으로 노출)
- 연결: linkedOrderId = null (SINGLE)

### Flow 4) 라켓 단품 구매

- 생성 문서: orders
- 관리자 목록 노출: /admin/orders
- 연결: 없음 (SINGLE)

### Flow 5) 라켓 구매 + 스트링 선택 + 교체서비스 신청 (연결된 통합)

- 생성 문서: orders + stringing_applications
- 관리자 목록 노출: /admin/orders (통합 그룹)
- 연결키:
  - stringing_applications.orderId → orders.\_id

### Flow 6) 라켓 단품 대여

- 생성 문서: rental_orders (또는 rentals 컬렉션)
- 관리자 목록 노출: /admin/rentals
- 연결: 없음 (SINGLE)

### Flow 7) 라켓 단품 대여 + 스트링 선택 + 교체서비스 신청 (연결된 대여 통합)

- 생성 문서: rental_orders + (대여 기반 stringing_application 연결 정보)
- 관리자 목록 노출: /admin/rentals (대여 상세에서 신청서 CTA)
- 연결키(현재 상세 API 기준):
  - rental_orders.stringingApplicationId → stringing_applications.\_id

---

## 3) 정산(매출) 기준 — 반드시 문서로 먼저 고정(중요)

> “보기에는 통합인데 실제 매출 집계가 빠지는 사고”를 막기 위한 핵심 섹션.
> 아래 항목을 확정한 뒤에 통합 화면을 설계한다.

### A. 주문(ORDER) 매출 인식

- 매출 포함: 주문 totalPrice (또는 total)
- 환불/취소: 어떤 상태에서 제외하는가?
  - [ ] 취소요청(requested) 단계에서는 포함
  - [ ] 취소승인(approved) 되면 제외
  - [ ] 결제완료(confirmed/paid)만 포함

### A-1. 주문 취소 vs 환불 운영 경계(관리자 UX 정책)

- 주문 취소와 환불은 상태명이 비슷해 보여도 운영 의미를 명확히 분리한다.
  - **취소**: 배송 전 단계에서 주문 자체를 무효화하는 상태 전이
  - **환불**: 배송 후 단계에서 금액 반환을 처리하는 상태 전이
- 관리자 상세(`/admin/orders/[id]`)에서 `주문 취소` 액션은 배송 전 상태에서만 허용한다.
- 배송중/배송완료 이후에는 취소 승인 API(`cancel-approve`)가 차단되며, 관리자는 상태 드롭다운의 `환불`을 사용해 후속 조치를 진행한다.
- 정책 문구는 운영 통합 센터/주문 상세에서 동일 톤으로 유지한다.
  - 권장 문구: `배송이 시작된 주문은 취소가 아닌 환불로 처리하세요.`

### B. 교체서비스 신청(STRINGING_APPLICATION) 매출 인식

- 매출 포함: 신청서 total (문서 저장값 우선)
- 단독 신청도 매출로 본다: [ ] YES / [ ] NO
- 환불/취소 기준: [ ] 주문과 동일 / [ ] 별도

### C. 대여(RENTAL) 매출 인식 (여기서부터 사고가 많이 난다)

- 대여료(fee)는 매출인가? [ ] YES / [ ] NO
- 보증금(deposit)은 매출인가? [ ] YES / [ ] NO (일반적으로 예치금 성격)
- 교체서비스 포함 대여의 매출은 어디로 넣는가?
  - [ ] 대여 매출에 포함(대여 화면에서 관리)
  - [ ] 신청서 매출로 분리(신청서/주문 쪽으로 이동)
  - [ ] 이원화(대여료는 대여, 교체서비스는 신청서)

---

## 4) 관리자 리스트(한 줄)에서 반드시 보여야 하는 필드(권장)

### 공통(필수)

거래종류(kind) 뱃지 (ORDER / 신청서 / RENTAL)

- 카테고리(category) 뱃지 (스트링/라켓/교체서비스/...)
- 연결(link) 뱃지 (단독/주문연결/대여연결)
- 고객(이름/이메일)
- 금액(총액) + 결제상태
- 현재 처리상태(주문상태)
- 생성일(또는 결제일)
- 다음 액션(상세로 이동, 배송 업데이트 등)

---

## 5) 변경 작업 원칙(안전장치)

- 기준표(본 문서) 확정 → UI 표시(뱃지/라벨) → 데이터 응답(필드 추가) → 통합 운영함 순으로 진행한다.
- 매출/정산 로직 변경은 “테스트 시나리오 체크리스트”와 함께 진행한다.


## 6) 알림 관리 라우팅 단일화 규칙

- 알림 관리의 단일 진입 경로는 **`/admin/notifications/outbox`** 로 고정한다.
- `/admin/notifications` 로 접근한 경우에는 query string을 유지한 채 `/admin/notifications/outbox` 로 리다이렉트한다.
- 관리자 메뉴 라벨은 실제 기능 의미와 동일하게 **“알림 발송함”** 으로 표기한다.
- 알림 상세(`/admin/notifications/outbox/[id]`)는 목록의 하위 경로로 간주하며, 상단 내비게이션/브레드크럼에서 목록→상세 관계를 동일하게 표시한다.


## 7) 운영 통합 센터 신호/결제 해석 정책 (2026-02)

- `주의`: 데이터 무결성/연결 오류일 때만 사용한다.
  - 예) 주문/대여/신청서 양방향 링크 누락, 존재하지 않는 문서 참조, 중복 연결
- `검수필요`: 오류는 아니지만 운영자 확인이 필요한 경우에 사용한다.
  - 예) 신청서 paymentStatus 미기재로 파생 결제상태 사용, packageApplied 적용, paymentSource=order:*/rental:*
- KPI 분류 기준:
  - `주의`: 데이터 무결성/연결 오류, reviewLevel=action, 결제취소/결제실패/확인필요 등 실제 이상 신호
  - `미처리`: 결제대기, 배송 정보 미등록, 배송중 후속 확인 등 정상 업무 대기
  - `참고`: reviewLevel=info(정상 파생/정책 문맥 참고)

화면 UX 정렬 원칙:
- `주의만`: 실제 오류(무결성/연결 문제)만 조회
- `검수필요만`: 오류는 아니지만 정책 확인이 필요한 건만 조회
- `완전정상만`: 주의/검수필요 신호가 모두 없는 건만 조회
- 그룹 펼침의 `검수 사유` 섹션에서 reviewReasons를 즉시 확인
- `주의(오류)만 보기`가 켜진 경우 `warnFilter`는 `주의만`으로 정규화해 충돌 조합(`검수필요만/완전정상만`)을 허용하지 않는다.

URL 동기화 규칙:
- 현재 뷰 링크는 `q/kind/flow/integrated/warn(page onlyWarn)/warnFilter/warnSort/page`를 함께 보존한다.
- `전체 보기`는 프리셋 + 위험 신호 필터(`warnFilter`) + 위험 신호 정렬(`warnSort`)까지 기본값으로 초기화한다.


금액 표시/해석 원칙(운영 통합 센터):
- 메인 금액(큰 숫자)은 항상 **실제 청구/결제 기준 금액**이다.
  - 주문: 주문 결제/청구 금액
  - 신청서: 신청서 자체 청구 금액(주문 포함/패키지 차감이면 0원 가능)
  - 대여: 대여 청구 금액
- 메인 금액이 `0원`인 신청서는 반드시 이유를 함께 해석한다.
  - `주문결제포함` / `대여결제포함` / `패키지차감` / `별도청구없음` / `확인필요`
- `serviceFeeBefore` 등 기준 금액은 **보조 정보**로만 사용한다.
  - 예) `0원 · 주문결제포함 · 기준금액 192,220원`
- 예) `0원 · 대여결제포함 · 기준금액 45,000원`

신청서 결제 라벨 우선순위:
1) paymentStatus 명시값 정규화
2) packageApplied=true → 패키지차감
3) paymentSource startsWith order: → 주문결제포함
4) paymentSource startsWith rental: → 대여결제포함
5) servicePaid=true → 결제완료
6) totalPrice>0 또는 serviceAmount>0 → 결제대기
7) 그 외 → 확인필요

주문 결제 라벨은 `paymentStatus ?? paymentInfo.status` 폴백을 사용한다.
대여는 결제 필드가 없을 수 있으므로 `paymentStatus/paymentInfo.status` 우선, 없으면 `대여 상태 + paidAt` 규칙으로 결제상태를 파생해 표시한다.


Flow 7(대여 + 교체서비스) 0원 해석 규칙:
- paymentSource가 `rental:<id>`이면 신청서 메인 금액이 0원이어도 `대여결제포함`으로 해석한다.
- `serviceFeeBefore`가 있으면 `기준금액`으로만 보조 표시하고, 메인 금액(실청구 기준)은 0원을 유지한다.
- 같은 0원이어도 문맥은 구분한다.
  - 주문 기반: `0원 · 주문결제포함`
  - 대여 기반: `0원 · 대여결제포함`
  - 패키지 차감: `0원 · 패키지차감`

## 8) 연결 업무 `다음 할 일(next action)` 분류 기준 (2026-02)

운영 통합 센터/상세 화면에서 `검수 사유`와 별도로, 관리자가 즉시 행동할 수 있는 짧은 문장으로 노출한다.

### A. 주문 + 신청
- 단계: `주문 결제 확인 단계`
  - 액션: `주문 결제 확인 및 연결 신청서 진행 가능 여부 확인 필요`
- 단계: `신청서 접수/검토 단계`
  - 액션: `신청서 작업 상태 확인 필요`
- 단계: `작업 진행 단계`
  - 액션: `작업 완료 후 신청서 교체완료 처리 필요`

### B. 대여 + 신청 (Flow 7)
- 단계: `Flow 7 · 결제 확인 단계`
  - 액션: `대여 결제 확인 필요`
- 단계: `Flow 7 · 출고 준비 단계`
  - 액션: `출고 정보 등록 필요`
- 단계: `Flow 7 · 교체 작업 단계`
  - 액션: `신청서 교체완료 처리 필요`
- 단계: `Flow 7 · 인도 대기 단계`
  - 액션: `사용자가 수령하면 대여 시작 처리 필요`

### C. 주문 단독(order only)
- 신청서(`stringing_application`) 연결이 없으면 주문 단독으로 간주한다.
- 단계: `주문 결제 확인 단계`
  - 액션: `주문 결제 확인 필요`
- 단계: `배송 준비 단계`
  - 액션: `배송 정보 등록 필요` 또는 `배송중 처리 필요`
- 단계: `배송 진행 단계`
  - 액션: `배송 완료 전 운송장/수령 상태 확인 필요`
- 단계: `배송 완료 단계`
  - 액션: `구매확정/환불 요청 여부 모니터링`
- 단계: `주문 종료 단계(취소/환불/결제취소)`
  - 액션: `후속 조치 없음`
- 규칙:
  - 신청서가 없는 경우 next action 문구에 신청서 점검 문맥을 넣지 않는다.
  - `환불/취소/결제취소`는 종단 상태로 우선 판정하며, 결제 확인 단계보다 먼저 종료 단계로 분류한다.
  - 배송 방법 표시는 `shippingInfo.shippingMethod ?? shippingInfo.deliveryMethod` fallback을 허용한다.

### D. 결제 라벨 문맥(패키지/주문결제포함/대여결제포함)
- 아래 라벨은 `검수필요` 신호일 수 있으나 자동 상태 변경 트리거는 아니다.
  - `패키지차감`
  - `주문결제포함`
  - `대여결제포함`
- 다음 할 일 가이드는 상태 변경을 자동 실행하지 않고, 관리자가 수동으로 상태 버튼/폼을 누르도록 안내만 제공한다.
- 신청서가 `접수완료/검토` 단계이면서 위 결제 라벨을 가지면 우선 `결제 문맥 검수 단계`로 안내한다.
- 이 안내는 운영함/주문상세/대여상세/신청상세에서 동일 텍스트 계열로 노출한다.

## 9) 주문/대여/신청 공통 상태 읽는 법 (운영 화면 공통)

- 관리자 목록/상세/운영함에서 상태는 아래 우선순위로 정렬해 읽는다.
  1. **업무 상태**: 문서 자체 진행 상태(주문 상태/대여 상태/신청 작업 상태)
  2. **결제 상태(용어 표준: 결제완료/결제대기)**: 결제완료/결제대기/결제취소/패키지차감/주문결제포함/대여결제포함
  3. **배송·출고 상태**: 수령방식, 운송장 등록, 출고/반납 운송장 여부
- 같은 의미의 라벨은 화면이 달라도 같은 텍스트/톤을 유지한다.
  - 예) 결제완료=성공 톤, 결제대기=경고 톤, 결제취소=위험 톤
- 대여 결제 상태(용어 표준: 결제완료/결제대기)는 `paymentStatus/paymentInfo.status`가 있으면 그 값을 우선 사용한다.
  - 필드가 비어 있으면 `대여 상태 + paidAt` 기준으로 `결제완료/결제대기`를 파생한다.
  - 파생값은 운영 검수 대상이며, 자동 상태 동기화는 수행하지 않는다.
- 운영 통합 센터에서 결제값이 비는 경우 `-` 대신 이유 문구를 보여주고 검수 사유에 남긴다.
